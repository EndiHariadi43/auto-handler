name: Cleanup Workflow History

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'   # Mingguan 00:00 UTC

permissions:
  actions: write

jobs:
  delete-old-workflows:
    runs-on: ubuntu-latest
    steps:
      - name: Install GitHub CLI
        run: |
          sudo apt update -y && sudo apt install -y gh jq

      - name: Cleanup workflow runs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching workflow run IDs to delete..."
          RUN_IDS=$(gh api repos/${{ github.repository }}/actions/runs \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              --jq '.workflow_runs[] | select(.status=="completed") | .id' | head -n 100)
          for ID in $RUN_IDS; do
            echo "Deleting workflow run ID: $ID"
            gh api --method DELETE repos/${{ github.repository }}/actions/runs/$ID \
              -H "Authorization: Bearer $GITHUB_TOKEN" || true
          done
